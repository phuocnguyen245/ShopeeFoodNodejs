const cookie = require('cookie');

module.exports = function(options = {}) {
	const secure = options.secure;
	return function(req, res, next) {
		res.flash = function(type, text) {
			const cookies = cookie.parse(req.headers.cookie) || {};
			const flashMessages = cookies.cookie_flash_message
				? JSON.parse(cookies.cookie_flash_message)
				: {};
			const messages = flashMessages[type] || [];
			messages.push(text);
			res.cookie('cookie_flash_message', JSON.stringify(flashMessages), {
				httpOnly: true,
				secure,
			});
		};

		req.flash = function() {
			if (req.headers.cookie) {
				const cookies = cookie.parse(req.headers.cookie);
				if (cookies.cookie_flash_message) {
					const flashMessages = JSON.parse(
						cookies.cookie_flash_message
					);

					res.clearCookie('cookie_flash_message');

					return flashMessages;
				}
			}
		};

		next();
	};
};
